<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NCM 前端批量解密器 · 带弹窗播放器</title>
  <link href="https://cdn.jsdelivr.net/npm/mdui@1.0.2/dist/css/mdui.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/mdui@1.0.2/dist/js/mdui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    :root{--bg:#071225;--card:#0f1724;--muted:#9fb3c8;--accent:#7c3aed;--accent2:#6ee7b7;--footer-height:72px}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#e6eef8;background:linear-gradient(180deg,var(--bg),#041222)}
    .page{min-height:100vh;display:flex;flex-direction:column}
    .container{width:100%;max-width:1280px;margin:0 auto;padding:18px;flex:1;display:flex;flex-direction:column}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:18px;box-shadow:0 12px 40px rgba(2,6,23,.55);display:flex;flex-direction:column;flex:1;min-height:320px;overflow:hidden}
    header.row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:20px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:6px}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#4c1d95);color:white;cursor:pointer;box-shadow:0 6px 18px rgba(124,58,237,.08);transition:transform .18s ease, box-shadow .18s ease}
    .btn:hover{transform:translateY(-3px);box-shadow:0 16px 30px rgba(0,0,0,.45)}
    .btn.outline{background:transparent;border:1px solid rgba(255,255,255,0.04)}
    .drop{margin-top:12px;border:2px dashed rgba(255,255,255,0.04);padding:18px;border-radius:12px;text-align:center;cursor:pointer;transition:all .18s}
    .drop.drag{background:rgba(124,58,237,0.04);border-color:rgba(124,58,237,0.5);transform:scale(1.01)}
    .list{margin-top:14px;display:flex;flex-direction:column;gap:8px;flex:1;overflow:auto;padding-right:6px}
    .rowItem{display:grid;grid-template-columns:96px 1fr 110px 110px 240px;gap:12px;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.005), rgba(255,255,255,0.002));transition:transform .18s ease, background .18s ease}
    .rowItem:hover{transform:translateY(-6px);background:linear-gradient(90deg, rgba(124,58,237,0.04), rgba(110,231,183,0.02));}
    .rowHeader{font-size:13px;color:var(--muted);font-weight:700}
    .cover{width:88px;height:88px;border-radius:8px;object-fit:cover;background:linear-gradient(180deg,#09101a,#0b1320)}
    .cover.round{border-radius:50%}
    .title{font-weight:700}
    .meta{color:var(--muted);font-size:13px;margin-top:6px}
    .progress{height:8px;border-radius:999px;background:rgba(255,255,255,0.03);overflow:hidden}
    .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .3s linear}
    .small{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    @media (max-width:1000px){.rowItem{grid-template-columns:72px 1fr 80px 80px 140px}.cover{width:64px;height:64px}}
    /* modal player */
    .modalMask{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;z-index:1200}
    .modal{width:min(760px,92vw);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:20px;box-shadow:0 30px 80px rgba(2,6,23,.7);display:flex;gap:18px;align-items:center}
    .disc{width:180px;height:180px;border-radius:50%;display:grid;place-items:center;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.03), transparent);box-shadow:inset 0 4px 14px rgba(0,0,0,0.4)}
    .disc img{width:84%;height:84%;border-radius:50%;object-fit:cover;transition:transform .6s linear}
    .disc.rotating img{animation:spin 6s linear infinite}
    @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    .playerInfo{flex:1}
    .playerTitle{font-size:18px;font-weight:700}
    .playerSub{color:var(--muted);margin-top:6px}
    .playerControls{display:flex;align-items:center;gap:12px;margin-top:12px}
    .progressBar{width:100%;height:8px;border-radius:999px;background:rgba(255,255,255,0.03);overflow:hidden}
    .progressBar > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .1s linear}
    .smallBtn{padding:6px 10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:white;cursor:pointer}
    footer.siteFooter{height:72px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.1), rgba(0,0,0,0.06));border-top:1px solid rgba(255,255,255,0.02)}
    .footerInner{max-width:1280px;width:100%;display:flex;align-items:center;justify-content:space-between;padding:12px 18px}
    .logoPlaceholder{width:40px;height:40px;border-radius:8px;background:rgba(255,255,255,0.03);display:inline-flex;align-items:center;justify-content:center;overflow:hidden}
    .bgGlow{position:fixed;right:-20%;bottom:-10%;width:60vmax;height:60vmax;border-radius:50%;background:radial-gradient(circle at 30% 30%, rgba(124,58,237,0.12), transparent 20%), radial-gradient(circle at 70% 70%, rgba(110,231,183,0.08), transparent 20%);filter:blur(80px);pointer-events:none;z-index:0;mix-blend-mode:screen;animation:float 18s infinite linear}
    @keyframes float{0%{transform:translateY(0) rotate(0);}50%{transform:translateY(-30px) rotate(10deg);}100%{transform:translateY(0) rotate(0);}}
  </style>
</head>
<body class="mdui-typo">
  <div class="page">
    <div class="bgGlow" aria-hidden="true"></div>
    <div class="container">
      <div class="card" role="main">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
          <div>
            <h1>NCM 前端批量解密器 <span class="small muted">带弹窗播放器</span></h1>
            <div class="subtitle">点击播放会弹出专属播放器窗口，封面为圆形并旋转，支持下载封面。</div>
          </div>
          <div class="controls">
            <button id="clearBtn" class="btn outline">清空</button>
            <button id="zipBtn" class="btn" disabled>全部打包 ZIP</button>
          </div>
        </div>

        <div id="drop" class="drop" role="button" tabindex="0" aria-label="拖放或选择文件">
          <div style="font-weight:600">把 .ncm 文件拖到这里，或点击选择文件</div>
          <div class="small muted" style="margin-top:8px">支持批量、封面预览、播放预览、单曲下载与批量打包</div>
          <div style="margin-top:10px"><label class="btn" style="cursor:pointer">选择文件<input id="fileInput" type="file" accept=".ncm" multiple hidden></label></div>
        </div>

        <div class="list" id="list" aria-live="polite">
          <div class="rowItem rowHeader" style="padding:10px 12px">
            <div>封面</div><div>歌曲信息</div><div>格式</div><div>时长</div><div style="text-align:right">操作</div>
          </div>
        </div>

      </div>
    </div>

    <footer class="siteFooter" role="contentinfo">
      <div class="footerInner">
        <div class="logoPlaceholder" id="footerLogo" title="把你的 logo 拖到这里或上传">你的 Logo</div>
        <div class="muted small">本工具仅作学习与个人备份，请遵守相关法律与服务条款。</div>
      </div>
    </footer>
  </div>

  <!-- 弹窗播放器 -->
  <div id="modalMask" class="modalMask" role="dialog" aria-hidden="true">
    <div class="modal" role="document">
      <div class="disc" id="disc">
        <img id="discImg" src="" alt="cover">
      </div>
      <div class="playerInfo">
        <div class="playerTitle" id="playerTitle">未知</div>
        <div class="playerSub" id="playerSub">未知</div>
        <div style="margin-top:12px" class="progressBar" aria-hidden="false"><i id="playerProgress"></i></div>
        <div class="playerControls">
          <button id="playerPlay" class="smallBtn">播放</button>
          <button id="playerPause" class="smallBtn" style="display:none">暂停</button>
          <button id="playerDownloadCover" class="smallBtn">下载封面</button>
          <button id="playerClose" class="smallBtn">关闭</button>
        </div>
      </div>
    </div>
  </div>

<script>
// constants & helpers
const CORE_KEY = CryptoJS.enc.Utf8.parse('hzHRAmso5kInbaxW');
const META_KEY = CryptoJS.enc.Utf8.parse("#14ljk_!\\\\]&0U<'(");
const $ = s => document.querySelector(s);
const list = $('#list'); const drop = $('#drop'); const inputFile = $('#fileInput'); const zipBtn = $('#zipBtn'); const clearBtn = $('#clearBtn');
const modal = document.getElementById('modalMask'); const disc = $('#disc'); const discImg = $('#discImg'); const playerTitle = $('#playerTitle'); const playerSub = $('#playerSub'); const playerProgress = $('#playerProgress');
const playerPlay = $('#playerPlay'); const playerPause = $('#playerPause'); const playerClose = $('#playerClose'); const playerDownloadCover = $('#playerDownloadCover');
let zip = null; let objectURLs = []; let currentAudio = null; let currentCoverBlob = null;

// drag & drop handlers
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('drag')}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('drag')}));
drop.addEventListener('drop', e=>handleFiles(e.dataTransfer.files)); inputFile.addEventListener('change', e=>handleFiles(e.target.files)); clearBtn.addEventListener('click', clearAll); zipBtn.addEventListener('click', async ()=>{ if (!zip) return; const blob = await zip.generateAsync({type:'blob'}); saveAs(blob, `ncm_exports_${Date.now()}.zip`); });

function clearAll(){ objectURLs.forEach(u=>URL.revokeObjectURL(u)); objectURLs=[]; list.querySelectorAll('.rowItem.item').forEach(n=>n.remove()); zip=null; zipBtn.disabled=true; mdui.snackbar({message:'已清空'}); }

function handleFiles(files){ const arr = Array.from(files).filter(f=>f.name.toLowerCase().endsWith('.ncm')); if (arr.length===0){ mdui.snackbar({message:'未检测到 .ncm 文件'}); return; } if (!zip) zip = new JSZip(); arr.forEach(f=>processOne(f)); }

function createRow(){ const row = document.createElement('div'); row.className='rowItem item'; row.innerHTML = `
  <div><img class="cover" src="" alt="cover" style="opacity:.18;border-radius:8px"></div>
  <div>
    <div class="title">解析中…</div>
    <div class="meta">文件：<span class="small muted filename"></span></div>
    <div style="margin-top:8px" class="progress" hidden><i style="width:0%"></i></div>
  </div>
  <div class="muted small format">--</div>
  <div class="muted small duration">--:--</div>
  <div style="text-align:right" class="rightAction">
    <button class="btn outline preview" disabled>播放</button>
    <button class="btn download" disabled>下载</button>
    <button class="btn outline coverDl" disabled>下载封面</button>
  </div>
`;
  list.appendChild(row); return row; }

function setProgress(row,p){ const bar = row.querySelector('.progress'); const inner = bar?.querySelector('i'); if (!bar) return; bar.hidden=false; inner.style.width = Math.min(100,Math.max(0,p))+'%'; if (p>=100) setTimeout(()=>bar.hidden=true,300); }

async function processOne(file){ const row = createRow(); row.querySelector('.filename').textContent = file.name; try{ const ab = await file.arrayBuffer(); const data = new Uint8Array(ab); setProgress(row,5); const out = ncmDecrypt(data, p=>setProgress(row,p*0.9+5)); setProgress(row,90);
    // cover
    if (out.cover && out.cover.length>8){ const mime = detectImageMime(out.cover); try{ const b = new Blob([out.cover], {type:mime}); const url = URL.createObjectURL(b); objectURLs.push(url); const img = row.querySelector('.cover'); img.src = url; img.style.opacity=1; // store blob
        row.__coverBlob = b; }catch(e){console.warn(e)} }
    // meta
    const title = out.meta?.musicName || file.name.replace(/\.ncm$/i,''); const artist = (out.meta?.artist || []).map(a=>a[0]).join(', ') || out.meta?.artistName || ''; const album = out.meta?.album || out.meta?.albumName || '';
    row.querySelector('.title').textContent = title + (artist?(' — '+artist):''); if (album) row.querySelector('.meta').textContent = '专辑：'+album;
    // audio blob
    const ext = (out.ext && out.ext.toLowerCase()) || (out.mime && out.mime.includes('flac')?'flac':'mp3'); const mime = out.mime || (ext==='flac'?'audio/flac':'audio/mpeg'); const audioBlob = new Blob([out.audio], {type:mime}); const audioUrl = URL.createObjectURL(audioBlob); objectURLs.push(audioUrl);
    const audio = new Audio(); audio.preload='metadata'; audio.src = audioUrl; audio.addEventListener('loadedmetadata', ()=>{ const d = audio.duration; row.querySelector('.duration').textContent = isFinite(d)?formatTime(d):'--:--'; });
    row.querySelector('.format').textContent = ext.toUpperCase(); const previewBtn = row.querySelector('.preview'); const downloadBtn = row.querySelector('.download'); const coverDl = row.querySelector('.coverDl'); previewBtn.disabled=false; downloadBtn.disabled=false; coverDl.disabled = !(row.__coverBlob);
    // play: open modal and play this audio
    previewBtn.addEventListener('click', ()=>{ openPlayer({title, artist, album, audioBlob, coverBlob: row.__coverBlob}); });
    downloadBtn.addEventListener('click', ()=> saveAs(audioBlob, sanitize(`${title} - ${artist || 'unknown'}.${ext}`)));
    coverDl.addEventListener('click', ()=>{ if (!row.__coverBlob) return; const cext = (detectImageMime(new Uint8Array(row.__coverBlob.slice(0,4)))==='image/png')?'.png':'.jpg'; saveAs(row.__coverBlob, sanitize(`${title} - ${artist || 'unknown'}${cext}`)); });
    // zip
    if (!zip) zip = new JSZip(); zip.file(sanitize(`${title} - ${artist || 'unknown'}.${ext}`), audioBlob); zipBtn.disabled=false;
    setProgress(row,100);
  }catch(err){ console.error(err); row.querySelector('.title').textContent = '解密失败：'+(err.message||err); setProgress(row,100); } }

function openPlayer({title, artist, album, audioBlob, coverBlob}){
  // cleanup previous
  cleanupPlayer();
  // set UI
  playerTitle.textContent = title; playerSub.textContent = (artist?artist: (album?album:''));
  // cover
  if (coverBlob){ const url = URL.createObjectURL(coverBlob); discImg.src = url; disc.classList.add('rotating'); objectURLs.push(url); currentCoverBlob = coverBlob; } else { discImg.src = ''; currentCoverBlob = null; }
  // audio element
  const url = URL.createObjectURL(audioBlob); objectURLs.push(url); const audio = new Audio(); audio.src = url; audio.preload='metadata'; currentAudio = audio;
  audio.addEventListener('timeupdate', ()=>{ const pct = (audio.currentTime / (audio.duration || 1)) * 100; playerProgress.style.width = Math.min(100, Math.max(0, pct)) + '%'; });
  audio.addEventListener('ended', ()=>{ playerPlay.style.display='inline-block'; playerPause.style.display='none'; disc.classList.remove('rotating'); });
  playerPlay.onclick = ()=>{ audio.play(); playerPlay.style.display='none'; playerPause.style.display='inline-block'; disc.classList.add('rotating'); };
  playerPause.onclick = ()=>{ audio.pause(); playerPlay.style.display='inline-block'; playerPause.style.display='none'; disc.classList.remove('rotating'); };
  playerDownloadCover.onclick = ()=>{ if (!currentCoverBlob) return; const ext = detectImageMime(new Uint8Array(currentCoverBlob.slice(0,4)))==='image/png'?'.png':'.jpg'; saveAs(currentCoverBlob, sanitize(`${title} - ${artist || 'unknown'}${ext}`)); };
  playerClose.onclick = ()=>{ closePlayer(); };
  // show modal and auto play
  modal.style.display='flex'; setTimeout(()=>{ audio.play().catch(()=>{}); playerPlay.style.display='none'; playerPause.style.display='inline-block'; disc.classList.add('rotating'); }, 160);
}

function cleanupPlayer(){ if (currentAudio){ try{ currentAudio.pause(); currentAudio.src=''; }catch(e){} currentAudio=null; } // remove disc rotation
  disc.classList.remove('rotating'); playerProgress.style.width='0%'; playerPlay.style.display='inline-block'; playerPause.style.display='none'; }

function closePlayer(){ if (currentAudio){ try{ currentAudio.pause(); currentAudio.src=''; }catch(e){} currentAudio=null; } // revoke any object URLs created for player (cover + audio)
  if (objectURLs && objectURLs.length){ objectURLs.forEach(u=>{ try{ URL.revokeObjectURL(u); }catch(e){} }); objectURLs = []; }
  modal.style.display='none'; cleanupPlayer(); }

function detectImageMime(bytes){ if (!bytes || bytes.length<4) return 'application/octet-stream'; if (bytes[0]===0xFF && bytes[1]===0xD8 && bytes[2]===0xFF) return 'image/jpeg'; if (bytes[0]===0x89 && bytes[1]===0x50 && bytes[2]===0x4E && bytes[3]===0x47) return 'image/png'; if (bytes[0]===0x47 && bytes[1]===0x49) return 'image/gif'; return 'application/octet-stream'; }
function formatTime(s){ if (!isFinite(s)) return '--:--'; const m=Math.floor(s/60); const sec=Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${sec}`; }
function sanitize(s){ return String(s||'').replace(/[\\\\/:*?"<>|]/g,'_').replace(/\\s+/g,' ').trim(); }

// ---------- NCM 解密核心 ----------
function ncmDecrypt(data, onProgress){
  const dv = new DataView(data.buffer, data.byteOffset, data.byteLength);
  const MAGIC = 'CTENFDAM';
  const sig = String.fromCharCode(...data.slice(0,8)); if (sig !== MAGIC) throw new Error('不是有效的 NCM 文件（缺少 CTENFDAM）');
  let off = 8 + 2; const keyLen = dv.getUint32(off, true); off += 4; let keyData = data.slice(off, off+keyLen); off += keyLen; for (let i=0;i<keyData.length;i++) keyData[i] ^= 0x64;
  const rc4Seed = aesEcbDecrypt(keyData, CORE_KEY); const seed = rc4Seed.slice(17); const keyBox = initKeyBox(seed);
  const metaLen = dv.getUint32(off, true); off += 4; let metaRaw = data.slice(off, off+metaLen); off += metaLen; for (let i=0;i<metaRaw.length;i++) metaRaw[i] ^= 0x63;
  const prefix = "163 key(Don't modify):"; let metaStr = new TextDecoder().decode(metaRaw); metaStr = metaStr.slice(prefix.length);
  const metaBytes = Uint8Array.from(atob(metaStr), c=>c.charCodeAt(0)); const metaDec = aesEcbDecrypt(metaBytes, META_KEY);
  const jsonStr = new TextDecoder().decode(metaDec).replace(/^music:/,''); let meta = {}; try{ meta = JSON.parse(jsonStr); }catch(e){ meta = {}; }
  off += 4 + 5; const imgSize = dv.getUint32(off, true); off += 4; const cover = data.slice(off, off+imgSize); off += imgSize; const audioEnc = data.slice(off);
  const audio = audioDec(audioEnc, keyBox, onProgress); const ext = (meta.format && meta.format.toLowerCase()) || guessExt(audio); const mime = ext === 'flac' ? 'audio/flac' : 'audio/mpeg'; return { audio, meta, cover, mime, ext };
}
function aesEcbDecrypt(bytes, key){ const wa = CryptoJS.lib.WordArray.create(bytes); const dec = CryptoJS.AES.decrypt({ciphertext: wa}, key, { mode: CryptoJS.mode.ECB, padding: CryptoJS.pad.Pkcs7 }); const out = new Uint8Array(dec.sigBytes); const words = dec.words; for (let i=0;i<out.length;i++){ const w = words[Math.floor(i/4)]; const shift = 24 - 8*(i%4); out[i] = (w >>> shift) & 0xff; } return out; }
function initKeyBox(seed){ const box = new Uint8Array(256); for (let i=0;i<256;i++) box[i]=i; let last=0, idx=0; for (let i=0;i<256;i++){ last = (box[i] + last + seed[idx]) & 0xff; [box[i], box[last]] = [box[last], box[i]]; idx = (idx + 1) % seed.length; } return box; }
function audioDec(enc, box, onProgress){ const out = new Uint8Array(enc.length); const CHUNK = 0x8000; for (let i=0;i<enc.length;i++){ const j = (i+1) & 0xff; out[i] = enc[i] ^ box[(box[j] + box[(box[j] + j) & 0xff]) & 0xff]; if (onProgress && (i%CHUNK===0)) onProgress(i/enc.length*100); } if (onProgress) onProgress(100); return out; }
function guessExt(bytes){ if (bytes[0]===0x66 && bytes[1]===0x4C && bytes[2]===0x61 && bytes[3]===0x43) return 'flac'; if (bytes[0]===0xFF && (bytes[1]&0xE0)===0xE0) return 'mp3'; return 'mp3'; }
</script>
</body>
</html>
